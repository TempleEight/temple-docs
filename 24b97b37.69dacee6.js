(window.webpackJsonp=window.webpackJsonp||[]).push([[7],{106:function(e,t,a){"use strict";a.r(t),a.d(t,"frontMatter",(function(){return o})),a.d(t,"metadata",(function(){return s})),a.d(t,"rightToc",(function(){return c})),a.d(t,"default",(function(){return u}));var n=a(1),i=(a(0),a(136)),r=a(138);const o={id:"authentication",title:"Authentication",sidebar_label:"Authentication"},s={id:"guide/authentication",title:"Authentication",description:"import useBaseUrl from '@docusaurus/useBaseUrl';",source:"@site/docs/guide/authentication.md",permalink:"/temple-docs/docs/guide/authentication",editUrl:"https://github.com/TempleEight/temple-docs/edit/master/TempleEight/docs/guide/authentication.md",sidebar_label:"Authentication",sidebar:"docsSidebar",previous:{title:"Adding Endpoints",permalink:"/temple-docs/docs/guide/adding-endpoints"},next:{title:"Enumeration",permalink:"/temple-docs/docs/guide/enumeration"}},c=[{value:"Adding Authentication to Your Project",id:"adding-authentication-to-your-project",children:[]},{value:"Testing the Authentication Changes",id:"testing-the-authentication-changes",children:[]},{value:"Registration and Login",id:"registration-and-login",children:[{value:"Registration",id:"registration",children:[]},{value:"Login",id:"login",children:[]}]},{value:"Authenticating Requests to Other Services",id:"authenticating-requests-to-other-services",children:[]},{value:"Services with <code>#auth</code> Metadata",id:"services-with-auth-metadata",children:[]},{value:"How Authentication is Implemented",id:"how-authentication-is-implemented",children:[]},{value:"Future Plans",id:"future-plans",children:[]}],l={rightToc:c};function u({components:e,...t}){return Object(i.b)("wrapper",Object(n.a)({},l,t,{components:e,mdxType:"MDXLayout"}),Object(i.b)("p",null,"A crucial component of most systems is its authentication system, namely validating that the user of a system is who they claim to be.\nAt Temple, we baked this directly into the generated architecture, so that you don't have to worry about getting the details right.\nIn this guide, we'll show you how to add authentication to your project and how this affects the system architecture, using the example project from the ",Object(i.b)("a",Object(n.a)({parentName:"p"},{href:"../getting-started"}),"Getting Started")," guide."),Object(i.b)("h2",{id:"adding-authentication-to-your-project"},"Adding Authentication to Your Project"),Object(i.b)("p",null,"The ",Object(i.b)("a",Object(n.a)({parentName:"p"},{href:"../getting-started"}),"Getting Started")," guide concluded with the following example Templefile:"),Object(i.b)("pre",null,Object(i.b)("code",Object(n.a)({parentName:"pre"},{}),"ExampleProject: project {\n  #language(go);\n  #database(postgres);\n  #provider(dockerCompose);\n}\n\nExampleService: service {\n  foo: string;\n  bar: int;\n}\n")),Object(i.b)("p",null,"To add authentication to this, we need to add two things:"),Object(i.b)("ol",null,Object(i.b)("li",{parentName:"ol"},Object(i.b)("strong",{parentName:"li"},"A project-level auth method metdata"))),Object(i.b)("ul",null,Object(i.b)("li",{parentName:"ul"},"This indicates how users will log in. Currently we only support ",Object(i.b)("inlineCode",{parentName:"li"},"email")," authentication, but we will be expanding this in the future.")),Object(i.b)("ol",{start:2},Object(i.b)("li",{parentName:"ol"},Object(i.b)("strong",{parentName:"li"},"A service-level auth metadata"))),Object(i.b)("ul",null,Object(i.b)("li",{parentName:"ul"},"This indicates one or many services which store metadata about your users, in addition to their authentication details.")),Object(i.b)("p",null,"We're going to apply these two modifications to our example Templefile by introducing a new service called ",Object(i.b)("inlineCode",{parentName:"p"},"ExampleUser"),", which will additionally store the user's name:"),Object(i.b)("pre",null,Object(i.b)("code",Object(n.a)({parentName:"pre"},{className:"language-templefile",metastring:"{5,8-11}","{5,8-11}":!0}),"ExampleProject: project {\n  #language(go);\n  #database(postgres);\n  #provider(dockerCompose);\n  #authMethod(email);\n}\n\nExampleUser: service {\n  name: string;\n  #auth;\n}\n\nExampleService: service {\n  foo: string;\n  bar: int;\n}\n")),Object(i.b)("p",null,"That's it - simple, right!\nUnder the hood, this makes lots of changes to your generated project so that:"),Object(i.b)("ul",null,Object(i.b)("li",{parentName:"ul"},"Users are required to login before accessing any service"),Object(i.b)("li",{parentName:"ul"},"Every service requires a valid authentication token"),Object(i.b)("li",{parentName:"ul"},"Created entities in each service are associated with a given user and access restricted appropriately. More information on this can be found in the ",Object(i.b)("a",Object(n.a)({parentName:"li"},{href:"access-control"}),"Access Control")," guide.")),Object(i.b)("h2",{id:"testing-the-authentication-changes"},"Testing the Authentication Changes"),Object(i.b)("p",null,"Previously, our system architecture was set out as follows:"),Object(i.b)("p",{align:"center"},Object(i.b)("img",{alt:"Tutorial System Architecture",src:Object(r.a)("img/tutorial-architecture.png"),width:"75%"})),Object(i.b)("p",null,"However, now we have introduced the ",Object(i.b)("inlineCode",{parentName:"p"},"ExampleUser")," service, as well as an automatically generated ",Object(i.b)("inlineCode",{parentName:"p"},"Auth")," service:"),Object(i.b)("p",{align:"center"},Object(i.b)("img",{alt:"Tutorial System Architecture with Authentication",src:Object(r.a)("img/tutorial-auth-architecture.png"),width:"75%"})),"Let's regenerate the project using `temple generate` as in the [Getting Started](../getting-started) guide, spin up the project and make some requests to the `ExampleService` service:",Object(i.b)("pre",null,Object(i.b)("code",Object(n.a)({parentName:"pre"},{className:"language-bash"}),'\u276f\u276f\u276f source deploy.sh\n...\n\u276f\u276f\u276f curl -X POST $KONG_ENTRY/api/example-service -d \'{"foo": "Hello", "bar": 123}\'\n{"message":"Unauthorized"}\n')),Object(i.b)("p",null,"Immediately we get a response back that the request is unauthorized.\nTo rectify this, we first need to register or login with the ",Object(i.b)("inlineCode",{parentName:"p"},"Auth")," service."),Object(i.b)("h2",{id:"registration-and-login"},"Registration and Login"),Object(i.b)("p",null,"The generated ",Object(i.b)("inlineCode",{parentName:"p"},"Auth")," service provides 2 endpoints: ",Object(i.b)("inlineCode",{parentName:"p"},"register")," and ",Object(i.b)("inlineCode",{parentName:"p"},"login"),".\nTheir names are fairly self explanatory, however let's see some examples of them in action:"),Object(i.b)("h3",{id:"registration"},"Registration"),Object(i.b)("p",null,"The ",Object(i.b)("inlineCode",{parentName:"p"},"register")," endpoint requires a POST request with a JSON object containing an ",Object(i.b)("inlineCode",{parentName:"p"},"email")," and ",Object(i.b)("inlineCode",{parentName:"p"},"password")," key.\nIn response, it will return an access token that will be used to authenticate subsequent requests.\nNote that we implicitly require the email address to be unique, such that one email address can only register once:"),Object(i.b)("pre",null,Object(i.b)("code",Object(n.a)({parentName:"pre"},{className:"language-bash"}),'# Initial registration\n\u276f\u276f\u276f curl -X POST $KONG_ENTRY/api/auth/register -d \'{"email": "hello@temple.com", "password": "abcdefgh"}\'\n{"AccessToken":"..."}\n\n# Subsequent registration\n\u276f\u276f\u276f curl -X POST $KONG_ENTRY/api/auth/register -d \'{"email": "hello@temple.com", "password": "abcdefgh"}\'\n{"error":"auth already exists"}\n')),Object(i.b)("h3",{id:"login"},"Login"),Object(i.b)("p",null,"The ",Object(i.b)("inlineCode",{parentName:"p"},"login")," endpoint again requires a POST request with a JSON object containing an ",Object(i.b)("inlineCode",{parentName:"p"},"email")," and ",Object(i.b)("inlineCode",{parentName:"p"},"password")," key.\nIn response, it will also return an access token that will be used to authenticate subsequent requests.\nIf the email doesn't exist, or the password is incorrect, an error will be returned."),Object(i.b)("pre",null,Object(i.b)("code",Object(n.a)({parentName:"pre"},{className:"language-bash"}),'# Auth exists and valid credentials provided\n\u276f\u276f\u276f curl -X POST $KONG_ENTRY/api/auth/login -d \'{"email": "hello@temple.com", "password": "abcdefgh"}\'\n{"AccessToken":"..."}\n\n# Auth exists, but password is invalid\n\u276f\u276f\u276f curl -X POST $KONG_ENTRY/api/auth/login -d \'{"email": "hello@temple.com", "password": "abcdefghijk"}\'\n{"error":"Invalid email or password"}\n\n# Auth doesn\'t exist\n\u276f\u276f\u276f curl -X POST $KONG_ENTRY/api/auth/login -d \'{"email": "goodbye@temple.com", "password": "abcdefghijk"}\'\n{"error":"Invalid email or password"}\n')),Object(i.b)("h2",{id:"authenticating-requests-to-other-services"},"Authenticating Requests to Other Services"),Object(i.b)("p",null,"Now that we are able to obtain an access token, we can make requests to other services by including the auth token in the request headers.\nWe use the Bearer Token framework, as defined in ",Object(i.b)("a",Object(n.a)({parentName:"p"},{href:"https://tools.ietf.org/html/rfc6750"}),"RFC6750"),"."),Object(i.b)("p",null,"Let's consider a full example of registration, followed by a request to ",Object(i.b)("inlineCode",{parentName:"p"},"ExampleService"),":"),Object(i.b)("pre",null,Object(i.b)("code",Object(n.a)({parentName:"pre"},{className:"language-bash"}),'\u276f\u276f\u276f curl -X POST $KONG_ENTRY/api/auth/register -d \'{"email": "test@temple.com", "password": "abcdefgh"}\'\n{"AccessToken":"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE1ODgwMTI3OTAsImlkIjoiNGZmYjAyZDQtODdlZC0xMWVhLWE4NjktMDI0MmFjMWYwMDAzIiwiaXNzIjoiaDFNT3hwN2lhTFFOTFA4ek1RS3k2VEkzcmpuNTlsM2MifQ.xNcAdY0r98J7rzNeEWSUPDTUg5HXOCFh41ZB74tTSw0"}\n\n\u276f\u276f\u276f curl -X POST $KONG_ENTRY/api/example-service -d \'{"foo": "hello", "bar": 123}\' -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE1ODgwMTI3OTAsImlkIjoiNGZmYjAyZDQtODdlZC0xMWVhLWE4NjktMDI0MmFjMWYwMDAzIiwiaXNzIjoiaDFNT3hwN2lhTFFOTFA4ek1RS3k2VEkzcmpuNTlsM2MifQ.xNcAdY0r98J7rzNeEWSUPDTUg5HXOCFh41ZB74tTSw0"\n{"id":"74045036-87ed-11ea-9edc-0242c0a81003","foo":"hello","bar":123}\n\n')),Object(i.b)("p",null,"Now we included a valid token in the Authorization header, the request was authorized and the entity successfully created."),Object(i.b)("h2",{id:"services-with-auth-metadata"},"Services with ",Object(i.b)("inlineCode",{parentName:"h2"},"#auth")," Metadata"),Object(i.b)("p",null,"You may have noticed that so far we have ignored the ",Object(i.b)("inlineCode",{parentName:"p"},"ExampleUser")," service we previously defined.\nThat's because it acts as any other service, so any example given in this guide could have been replace with a call to that service too."),Object(i.b)("p",null,"However, it has one distinguishing feature: a single token is only able to create a single entity in this service.\nThis means means that there is at most a one-to-one mapping between an entity in the ",Object(i.b)("inlineCode",{parentName:"p"},"Auth")," service, and an entity in the ",Object(i.b)("inlineCode",{parentName:"p"},"ExampleUser")," service.\nThis makes the ",Object(i.b)("inlineCode",{parentName:"p"},"ExampleUser")," service perfect for storing additional metadata about a user, such as their name, address or anything that fits your business needs."),Object(i.b)("h2",{id:"how-authentication-is-implemented"},"How Authentication is Implemented"),Object(i.b)("p",null,"To best explain the changes made when authentication is added to your project let's consider how a new user registers with your service:"),Object(i.b)("h4",{id:"pre-request-preparation"},"Pre-request Preparation"),Object(i.b)("p",null,"Before any request is even issued to your ",Object(i.b)("inlineCode",{parentName:"p"},"Auth")," service, several steps are taken:"),Object(i.b)("ul",null,Object(i.b)("li",{parentName:"ul"},"The ",Object(i.b)("inlineCode",{parentName:"li"},"Auth")," service registers as a consumer with Kong (",Object(i.b)("a",Object(n.a)({parentName:"li"},{href:"https://docs.konghq.com/2.0.x/getting-started/adding-consumers/#1-create-a-consumer-through-the-restful-api"}),"see the Kong documentation"),")"),Object(i.b)("li",{parentName:"ul"},"The ",Object(i.b)("inlineCode",{parentName:"li"},"Auth")," service requests a new HS256 JWT credential from Kong, used to sign each token"),Object(i.b)("li",{parentName:"ul"},"All other services, other than ",Object(i.b)("inlineCode",{parentName:"li"},"Auth"),", are configured through Kong to require a JWT as part of the request body")),Object(i.b)("h4",{id:"making-a-register-request"},"Making a Register Request"),Object(i.b)("p",null,"Upon making a request to the ",Object(i.b)("inlineCode",{parentName:"p"},"/register")," endpoint, the service will:"),Object(i.b)("ul",null,Object(i.b)("li",{parentName:"ul"},"Validate the email and password",Object(i.b)("ul",{parentName:"li"},Object(i.b)("li",{parentName:"ul"},"We currently impose a minimum 8 character limit on the passwords, but you can extend these in your custom defined hooks - see the ",Object(i.b)("a",Object(n.a)({parentName:"li"},{href:"hooks"}),"Hooks")," guide for more."))),Object(i.b)("li",{parentName:"ul"},"Validate that a user with that email address doesn't already exist"),Object(i.b)("li",{parentName:"ul"},"Hash and salt the password using ",Object(i.b)("a",Object(n.a)({parentName:"li"},{href:"https://godoc.org/golang.org/x/crypto/bcrypt"}),"bcrypt")),Object(i.b)("li",{parentName:"ul"},"Generate a UUID for that user, according to UUID version 1 of ",Object(i.b)("a",Object(n.a)({parentName:"li"},{href:"https://tools.ietf.org/html/rfc4122"}),"RFC4122")),Object(i.b)("li",{parentName:"ul"},"Generate a HS256 JWT, using the ",Object(i.b)("a",Object(n.a)({parentName:"li"},{href:"https://github.com/dgrijalva/jwt-go"}),"JWT Go library"),", which generates JWTs according to ",Object(i.b)("a",Object(n.a)({parentName:"li"},{href:"https://tools.ietf.org/html/rfc7519"}),"RFC7519"),Object(i.b)("ul",{parentName:"li"},Object(i.b)("li",{parentName:"ul"},"This JWT has 3 claims:",Object(i.b)("ol",{parentName:"li"},Object(i.b)("li",{parentName:"ol"},Object(i.b)("inlineCode",{parentName:"li"},"id"),": the UUID assigned to that entity"),Object(i.b)("li",{parentName:"ol"},Object(i.b)("inlineCode",{parentName:"li"},"iss"),": the issuer claim (as defined by ",Object(i.b)("a",Object(n.a)({parentName:"li"},{href:"https://tools.ietf.org/html/rfc7519"}),"RFC7519"),")"),Object(i.b)("li",{parentName:"ol"},Object(i.b)("inlineCode",{parentName:"li"},"exp"),": the expiry of the token, set 24 hours in the future from the current time (again, as defined in ",Object(i.b)("a",Object(n.a)({parentName:"li"},{href:"https://tools.ietf.org/html/rfc7519"}),"RFC7519"),")")))))),Object(i.b)("p",null,"These same steps are applied when logging in, except for the additional step where the stored hashed and salted password is compared against the provided password."),Object(i.b)("h4",{id:"making-a-request-to-another-service"},"Making a Request to Another Service"),Object(i.b)("p",null,"Upon making a request to a service other than ",Object(i.b)("inlineCode",{parentName:"p"},"Auth"),", the following steps are taken before a request is executed:"),Object(i.b)("ul",null,Object(i.b)("li",{parentName:"ul"},"Kong validates that a JWT is included with the request, under the ",Object(i.b)("inlineCode",{parentName:"li"},"Authorization")," header, with the prefix ",Object(i.b)("inlineCode",{parentName:"li"},"Bearer"),", otherwise returns a 401 Unauthorized response"),Object(i.b)("li",{parentName:"ul"},"Kong validates the JWT comparing the ",Object(i.b)("inlineCode",{parentName:"li"},"iss")," claim against the known secret, otherwise returns a 401 Unauthorized response"),Object(i.b)("li",{parentName:"ul"},"Kong validates the JWT has not yet expired, otherwise returns a 401 Unauthorized response")),Object(i.b)("p",null,"After this, Kong forwards the request to the necessary service.\nThis service will then extract the UUID from the ",Object(i.b)("inlineCode",{parentName:"p"},"id")," claim in this token and use it to associate any entity created with that specific UUID."),Object(i.b)("h2",{id:"future-plans"},"Future Plans"),Object(i.b)("p",null,"Obviously this does not provide a solution for every possible authentication scenario, so in the future we plan to:"),Object(i.b)("ul",null,Object(i.b)("li",{parentName:"ul"},"Expand from email authentication to include usernames, OAuth and social logins"),Object(i.b)("li",{parentName:"ul"},"Include a refresh token in the register or login response, removing the need to make the user sign in every 24 hours"),Object(i.b)("li",{parentName:"ul"},"Allow for more configuration of JWTs, defining custom claims or varying expiry times")))}u.isMDXComponent=!0},136:function(e,t,a){"use strict";a.d(t,"a",(function(){return h})),a.d(t,"b",(function(){return p}));var n=a(0),i=a.n(n);function r(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function o(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function s(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?o(Object(a),!0).forEach((function(t){r(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):o(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function c(e,t){if(null==e)return{};var a,n,i=function(e,t){if(null==e)return{};var a,n,i={},r=Object.keys(e);for(n=0;n<r.length;n++)a=r[n],t.indexOf(a)>=0||(i[a]=e[a]);return i}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(n=0;n<r.length;n++)a=r[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(i[a]=e[a])}return i}var l=i.a.createContext({}),u=function(e){var t=i.a.useContext(l),a=t;return e&&(a="function"==typeof e?e(t):s({},t,{},e)),a},h=function(e){var t=u(e.components);return i.a.createElement(l.Provider,{value:t},e.children)},b={inlineCode:"code",wrapper:function(e){var t=e.children;return i.a.createElement(i.a.Fragment,{},t)}},d=Object(n.forwardRef)((function(e,t){var a=e.components,n=e.mdxType,r=e.originalType,o=e.parentName,l=c(e,["components","mdxType","originalType","parentName"]),h=u(a),d=n,p=h["".concat(o,".").concat(d)]||h[d]||b[d]||r;return a?i.a.createElement(p,s({ref:t},l,{components:a})):i.a.createElement(p,s({ref:t},l))}));function p(e,t){var a=arguments,n=t&&t.mdxType;if("string"==typeof e||n){var r=a.length,o=new Array(r);o[0]=d;var s={};for(var c in t)hasOwnProperty.call(t,c)&&(s[c]=t[c]);s.originalType=e,s.mdxType="string"==typeof e?e:n,o[1]=s;for(var l=2;l<r;l++)o[l]=a[l];return i.a.createElement.apply(null,o)}return i.a.createElement.apply(null,a)}d.displayName="MDXCreateElement"},137:function(e,t,a){"use strict";var n=a(0),i=a(34);t.a=function(){return Object(n.useContext)(i.a)}},138:function(e,t,a){"use strict";a.d(t,"a",(function(){return i}));var n=a(137);function i(e){const{siteConfig:t}=Object(n.a)(),{baseUrl:a="/"}=t||{};if(!e)return e;return/^(https?:|\/\/)/.test(e)?e:e.startsWith("/")?a+e.slice(1):a+e}}}]);