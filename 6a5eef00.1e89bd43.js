(window.webpackJsonp=window.webpackJsonp||[]).push([[11],{143:function(e,t,n){"use strict";n.r(t),n.d(t,"frontMatter",(function(){return i})),n.d(t,"metadata",(function(){return c})),n.d(t,"rightToc",(function(){return s})),n.d(t,"default",(function(){return p}));var r=n(1),a=n(9),o=(n(0),n(169)),i=(n(171),{id:"orchestration",title:"Orchestration",sidebar_label:"Orchestration"}),c={id:"guide/orchestration",title:"Orchestration",description:"import useBaseUrl from '@docusaurus/useBaseUrl';",source:"@site/docs/guide/orchestration.md",permalink:"/temple-docs/docs/guide/orchestration",editUrl:"https://github.com/TempleEight/temple-docs/edit/master/TempleEight/docs/guide/orchestration.md",sidebar_label:"Orchestration",sidebar:"docsSidebar",previous:{title:"OpenAPI Generation",permalink:"/temple-docs/docs/guide/open-api"},next:{title:"Regeneration",permalink:"/temple-docs/docs/guide/regeneration"}},s=[{value:"Adding Orchestration to your Templefile",id:"adding-orchestration-to-your-templefile",children:[]},{value:"Docker Compose",id:"docker-compose",children:[]},{value:"Kubernetes",id:"kubernetes",children:[]},{value:"Kong API Gateway",id:"kong-api-gateway",children:[]}],l={rightToc:s};function p(e){var t=e.components,n=Object(a.a)(e,["components"]);return Object(o.b)("wrapper",Object(r.a)({},l,n,{components:t,mdxType:"MDXLayout"}),Object(o.b)("p",null,"Orchestration provides a fundamental building block of most modern service-oriented architectures, and Temple's generated projects are no exception.\nTemple provides several industry standards methods of automatically deploying your services."),Object(o.b)("p",null,"The currently supported frameworks are:"),Object(o.b)("ul",null,Object(o.b)("li",{parentName:"ul"},"Docker Compose"),Object(o.b)("li",{parentName:"ul"},"Kubernetes")),Object(o.b)("h2",{id:"adding-orchestration-to-your-templefile"},"Adding Orchestration to your Templefile"),Object(o.b)("p",null,"Orchestrating your project automatically requires only a single line of configuration in your Templefile.\nWorking from the example in the ",Object(o.b)("a",Object(r.a)({parentName:"p"},{href:"../getting-started"}),"Getting Started")," guide:"),Object(o.b)("pre",null,Object(o.b)("code",Object(r.a)({parentName:"pre"},{className:"language-templefile",metastring:"{4}","{4}":!0}),"ExampleProject: project {\n  #language(go);\n  #database(postgres);\n  #provider(dockerCompose);\n}\n\nExampleService: service {\n  foo: string;\n  bar: int;\n}\n")),Object(o.b)("p",null,"Here, the ",Object(o.b)("inlineCode",{parentName:"p"},"#provider")," annotation marks that this project is being orchestrated, with the framework provided in the argument.\nAll of the frameworks are generated to share a common deployment script that does all the heavy lifting, so that usage is the same no matter which you choose.\nThis includes the ",Object(o.b)("a",Object(r.a)({parentName:"p"},{href:"https://docs.konghq.com/"}),"Kong API Gateway")," for ingress, which is detailed ",Object(o.b)("a",Object(r.a)({parentName:"p"},{href:"#kong-api-gateway"}),"below")),Object(o.b)("h2",{id:"docker-compose"},"Docker Compose"),Object(o.b)("p",null,Object(o.b)("a",Object(r.a)({parentName:"p"},{href:"https://docs.docker.com/compose/"}),"Docker Compose")," is a tool built into the Docker ecosystem for orchestrating containers.\nWe recommend using it for local development, as running your services this way has comparatively little overhead.\nHowever it doesn't allow for some more advanced features like automatically replicating and distributing services across different machines out of the box."),Object(o.b)("p",null,"When the ",Object(o.b)("inlineCode",{parentName:"p"},"dockerCompose")," provider is selected, Temple generates three important files, namely:"),Object(o.b)("pre",null,Object(o.b)("code",Object(r.a)({parentName:"pre"},{className:"language-shell"}),".\n\u251c\u2500\u2500 deploy.sh\n\u251c\u2500\u2500 docker-compose.yml\n\u2514\u2500\u2500 kong\n    \u2514\u2500\u2500 configure-kong.sh\n")),Object(o.b)("p",null,Object(o.b)("inlineCode",{parentName:"p"},"docker-compose.yml")," instructs Docker Compose on how to manage your services.\nIt specifies, for each service, which Docker image should be used in the container, any volume mounts, and environment variables needed.\nIt also defines networking, allowing certain services to speak to others (for example, only one service should be able to communicate with each database)."),Object(o.b)("p",null,Object(o.b)("inlineCode",{parentName:"p"},"kong/configure-kong.sh")," is a script that is ran once the docker-compose infrastructure is running.\nIt sends a series of ",Object(o.b)("inlineCode",{parentName:"p"},"cURL")," requests to the ",Object(o.b)("inlineCode",{parentName:"p"},"Kong")," API gateway which configures it to route requests it receives to the correct service, and to deal with any authentication required\n(see the ",Object(o.b)("a",Object(r.a)({parentName:"p"},{href:"authentication"}),"Authentication")," Guide, and the ",Object(o.b)("a",Object(r.a)({parentName:"p"},{href:"https://docs.konghq.com/2.0.x/getting-started/quickstart/"}),"Kong Documentation"),")."),Object(o.b)("p",null,"Finally the ",Object(o.b)("inlineCode",{parentName:"p"},"deploy.sh")," script is a shell script to automate starting your application.\nThis file performs all of the steps needed to get everything running correctly, including runnning the ",Object(o.b)("inlineCode",{parentName:"p"},"configure-kong.sh")," script and setting the ",Object(o.b)("inlineCode",{parentName:"p"},"$KONG_ENTRY")," and ",Object(o.b)("inlineCode",{parentName:"p"},"$KONG_ADMIN")," environment variables.\nIn order for these variables to remain set for the remainder of your terminal session, it needs to be run with the ",Object(o.b)("inlineCode",{parentName:"p"},"source")," command."),Object(o.b)("p",null,"Assuming you have the Docker daemon up and running, let's spin up our application:"),Object(o.b)("pre",null,Object(o.b)("code",Object(r.a)({parentName:"pre"},{className:"language-shell"}),"\u276f\u276f\u276f source deploy.sh\n")),Object(o.b)("p",null,"A lot of output will be presented, detailing each step of the deployment process, and any errors that occurred. "),Object(o.b)("p",null,"Verify the system was configured correctly by checking the environment variables:"),Object(o.b)("pre",null,Object(o.b)("code",Object(r.a)({parentName:"pre"},{className:"language-shell"}),"\u276f\u276f\u276f echo $KONG_ENTRY \nlocalhost:8000\n\n\u276f\u276f\u276f echo $KONG_ADMIN\nlocalhost:8001\n")),Object(o.b)("p",null,"At this point, you're free to make requests to your services.\nIn order to access them, address requests to Kong's ingress URL: ",Object(o.b)("inlineCode",{parentName:"p"},"$KONG_ENTRY/api/{service-name}/{entity-id}")," and Kong will forward the request to the right place."),Object(o.b)("p",null,"Once you are finished with your infrastructure, everything can be cleanly shut down with:"),Object(o.b)("pre",null,Object(o.b)("code",Object(r.a)({parentName:"pre"},{className:"language-shell"}),"\u276f\u276f\u276f docker-compose down\n")),Object(o.b)("h2",{id:"kubernetes"},"Kubernetes"),Object(o.b)("p",null,"Another common framework for orchestrating services is ",Object(o.b)("a",Object(r.a)({parentName:"p"},{href:"https://kubernetes.io/"}),"Kubernetes"),"(kube, k8s).\nIt's a more heavyweight tool than Docker Compose, but has much more mature features and is generally seen as more 'production grade'."),Object(o.b)("p",null,"By changing the ",Object(o.b)("inlineCode",{parentName:"p"},"#provider")," annotation in a Templefile's project block to read ",Object(o.b)("inlineCode",{parentName:"p"},"#provider(kubernetes)"),",\nTemple will generate the required config to run your services in K8s. "),Object(o.b)("p",null,"Changing the ",Object(o.b)("inlineCode",{parentName:"p"},"example.temple")," file from the ",Object(o.b)("a",Object(r.a)({parentName:"p"},{href:"../getting-started"}),"Getting Started")," guide to use this ",Object(o.b)("inlineCode",{parentName:"p"},"#provider")," annotation and then regenerating the project,\nresults in the following configuration files:"),Object(o.b)("pre",null,Object(o.b)("code",Object(r.a)({parentName:"pre"},{className:"language-shell"}),".\n\u251c\u2500\u2500 deploy.sh\n\u251c\u2500\u2500 kong\n\u2502   \u2514\u2500\u2500 configure-kong.sh\n\u251c\u2500\u2500 kube\n\u2502   \u251c\u2500\u2500 deploy\n\u2502   \u2502   \u251c\u2500\u2500 deploy-daemon-set.yaml\n\u2502   \u2502   \u251c\u2500\u2500 deploy-replication-controller.yaml\n\u2502   \u2502   \u2514\u2500\u2500 deploy-service.yaml\n\u2502   \u251c\u2500\u2500 example-service\n\u2502   \u2502   \u251c\u2500\u2500 db-deployment.yaml\n\u2502   \u2502   \u251c\u2500\u2500 db-service.yaml\n\u2502   \u2502   \u251c\u2500\u2500 db-storage.yaml\n\u2502   \u2502   \u251c\u2500\u2500 deployment.yaml\n\u2502   \u2502   \u2514\u2500\u2500 service.yaml\n\u2502   \u2514\u2500\u2500 kong\n\u2502       \u251c\u2500\u2500 kong-db-deployment.yaml\n\u2502       \u251c\u2500\u2500 kong-db-service.yaml\n\u2502       \u251c\u2500\u2500 kong-deployment.yaml\n\u2502       \u251c\u2500\u2500 kong-migration-job.yaml\n\u2502       \u2514\u2500\u2500 kong-service.yaml\n\u2514\u2500\u2500 push-image.sh\n")),Object(o.b)("p",null,"As you can see, there are a lot more files generated here than for Docker Compose."),Object(o.b)("p",null,"The ",Object(o.b)("inlineCode",{parentName:"p"},"deploy.sh")," and ",Object(o.b)("inlineCode",{parentName:"p"},"configure-kong.sh")," scripts serve the same purpose here as they do in the Docker Compose example,\nalthough the mechanisms used to achieve this are different."),Object(o.b)("p",null,"The ",Object(o.b)("inlineCode",{parentName:"p"},"push-image.sh")," script builds Docker images from each service generated in your project.\nSince Kubernetes requires all images used in your system to be hosted in a ",Object(o.b)("a",Object(r.a)({parentName:"p"},{href:"https://docs.docker.com/registry/"}),"Docker Registry"),", Temple's Kubernetes infrastructure features its own registry, hosted in the cluster itself.\nThis script pushes all of the built images to this registry for K8s to use."),Object(o.b)("div",{className:"admonition admonition-info alert alert--info"},Object(o.b)("div",Object(r.a)({parentName:"div"},{className:"admonition-heading"}),Object(o.b)("h5",{parentName:"div"},Object(o.b)("span",Object(r.a)({parentName:"h5"},{className:"admonition-icon"}),Object(o.b)("svg",Object(r.a)({parentName:"span"},{xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"}),Object(o.b)("path",Object(r.a)({parentName:"svg"},{fillRule:"evenodd",d:"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"})))),"info")),Object(o.b)("div",Object(r.a)({parentName:"div"},{className:"admonition-content"}),Object(o.b)("p",{parentName:"div"},"Due to a ",Object(o.b)("a",Object(r.a)({parentName:"p"},{href:"https://github.com/docker/for-mac/issues/3611"}),"known issue in Docker for Mac"),", pushing to a local registry doesn't work by default.\nUntil this is fixed, a simple work around is to change the following line in your ",Object(o.b)("inlineCode",{parentName:"p"},"/etc/hosts")," file:"),Object(o.b)("pre",{parentName:"div"},Object(o.b)("code",Object(r.a)({parentName:"pre"},{}),"127.0.0.1   localhost\n")),Object(o.b)("p",{parentName:"div"},"Change it to:"),Object(o.b)("pre",{parentName:"div"},Object(o.b)("code",Object(r.a)({parentName:"pre"},{}),"127.0.0.1   localhost registry.me\n")),Object(o.b)("p",{parentName:"div"},"Then set the ",Object(o.b)("inlineCode",{parentName:"p"},"$REG_URL")," environment variable to be ",Object(o.b)("inlineCode",{parentName:"p"},"registry.me:5000")," before running the ",Object(o.b)("inlineCode",{parentName:"p"},"deploy.sh")," script."))),Object(o.b)("p",null,"The aforementioned registry has its configuration files in the ",Object(o.b)("inlineCode",{parentName:"p"},"kube/deploy")," directory.\nThe rest of the ",Object(o.b)("inlineCode",{parentName:"p"},"kube")," directory features the ",Object(o.b)("inlineCode",{parentName:"p"},"yaml")," configuration files for each other service managed by Kubernetes, including Kong."),Object(o.b)("p",null,"To run this example, we assume you have ",Object(o.b)("a",Object(r.a)({parentName:"p"},{href:"https://minikube.sigs.k8s.io/docs/"}),Object(o.b)("inlineCode",{parentName:"a"},"minikube"))," installed.\nSee the ",Object(o.b)("a",Object(r.a)({parentName:"p"},{href:"https://kubernetes.io/docs/home"}),"Kubernetes documentation")," for a full reference on how to deploy your services into a production environment."),Object(o.b)("p",null,"Run your application with the same methods as with Docker Compose:"),Object(o.b)("pre",null,Object(o.b)("code",Object(r.a)({parentName:"pre"},{className:"language-shell"}),"\u276f\u276f\u276f source deploy.sh\n")),Object(o.b)("p",null,"Kubernetes infrastructure will take a lot longer to spin up, as it creates an entire Virtual Machine in ",Object(o.b)("inlineCode",{parentName:"p"},"VirtualBox"),"."),Object(o.b)("p",null,"Once everything is running, you can use the infrastructure in the exact same way as with Docker Compose."),Object(o.b)("p",null,"In order to shut down your cluster and delete any config it's left behind, run:"),Object(o.b)("pre",null,Object(o.b)("code",Object(r.a)({parentName:"pre"},{className:"language-shell"}),'\u276f\u276f\u276f minikube delete\n\ud83d\udd25  Deleting "minikube" in virtualbox ...\n\ud83d\udc80  Removed all traces of the "minikube" cluster.\n')),Object(o.b)("h2",{id:"kong-api-gateway"},"Kong API Gateway"),Object(o.b)("p",null,"An API Gateway is an infrastructure component designed to be the entry point to your application.\nIt receives all requests from the user, performs actions like verifying their authentication, and then forwards the request to the correct microservice."),Object(o.b)("p",null,"Temple makes use of the existing ",Object(o.b)("a",Object(r.a)({parentName:"p"},{href:"https://docs.konghq.com/2.0.x/getting-started/quickstart/"}),"Kong API Gateway")," for this purpose, and automatically generates all the configuration it requires."),Object(o.b)("p",null,"An API Gateway provides a single entry point into your project infrastructure, meaning it can direct requests to deployed services whether they are on a single machine or multiple machines.\nTo do this, requests need to be addressed to Kong's URL.\nTemple's tooling automatically sets this URL into an environment variable called ",Object(o.b)("inlineCode",{parentName:"p"},"$KONG_ENTRY"),". "),Object(o.b)("p",null,"As previously mentioned, Kong also handles some end-user authentication, when it's used in your project.\nSee the ",Object(o.b)("a",Object(r.a)({parentName:"p"},{href:"authentication"}),"Authentication")," Guide for full details of this."))}p.isMDXComponent=!0},169:function(e,t,n){"use strict";n.d(t,"a",(function(){return u})),n.d(t,"b",(function(){return m}));var r=n(0),a=n.n(r);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function c(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},o=Object.keys(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var l=a.a.createContext({}),p=function(e){var t=a.a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):c({},t,{},e)),n},u=function(e){var t=p(e.components);return a.a.createElement(l.Provider,{value:t},e.children)},b={inlineCode:"code",wrapper:function(e){var t=e.children;return a.a.createElement(a.a.Fragment,{},t)}},d=Object(r.forwardRef)((function(e,t){var n=e.components,r=e.mdxType,o=e.originalType,i=e.parentName,l=s(e,["components","mdxType","originalType","parentName"]),u=p(n),d=r,m=u["".concat(i,".").concat(d)]||u[d]||b[d]||o;return n?a.a.createElement(m,c({ref:t},l,{components:n})):a.a.createElement(m,c({ref:t},l))}));function m(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=n.length,i=new Array(o);i[0]=d;var c={};for(var s in t)hasOwnProperty.call(t,s)&&(c[s]=t[s]);c.originalType=e,c.mdxType="string"==typeof e?e:r,i[1]=c;for(var l=2;l<o;l++)i[l]=n[l];return a.a.createElement.apply(null,i)}return a.a.createElement.apply(null,n)}d.displayName="MDXCreateElement"},170:function(e,t,n){"use strict";var r=n(0),a=n(49);t.a=function(){return Object(r.useContext)(a.a)}},171:function(e,t,n){"use strict";n.d(t,"a",(function(){return a}));n(175);var r=n(170);function a(e){var t=(Object(r.a)().siteConfig||{}).baseUrl,n=void 0===t?"/":t;if(!e)return e;return/^(https?:|\/\/)/.test(e)?e:e.startsWith("/")?n+e.slice(1):n+e}},173:function(e,t,n){var r=n(69),a=n(23);e.exports=function(e,t,n){if(r(t))throw TypeError("String#"+n+" doesn't accept regex!");return String(a(e))}},174:function(e,t,n){var r=n(2)("match");e.exports=function(e){var t=/./;try{"/./"[e](t)}catch(n){try{return t[r]=!1,!"/./"[e](t)}catch(a){}}return!0}},175:function(e,t,n){"use strict";var r=n(17),a=n(35),o=n(173),i="".startsWith;r(r.P+r.F*n(174)("startsWith"),"String",{startsWith:function(e){var t=o(this,e,"startsWith"),n=a(Math.min(arguments.length>1?arguments[1]:void 0,t.length)),r=String(e);return i?i.call(t,r,n):t.slice(n,n+r.length)===r}})}}]);