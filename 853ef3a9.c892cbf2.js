(window.webpackJsonp=window.webpackJsonp||[]).push([[14],{153:function(e,t,a){"use strict";a.r(t),a.d(t,"frontMatter",(function(){return s})),a.d(t,"metadata",(function(){return c})),a.d(t,"rightToc",(function(){return l})),a.d(t,"default",(function(){return p}));var n=a(1),r=a(11),i=(a(0),a(176)),o=a(178),s={id:"metrics",title:"Metrics",sidebar_label:"Metrics"},c={id:"guide/metrics",title:"Metrics",description:"import useBaseUrl from '@docusaurus/useBaseUrl';",source:"@site/docs/guide/metrics.md",permalink:"/temple-docs/docs/guide/metrics",editUrl:"https://github.com/TempleEight/temple-docs/edit/master/TempleEight/docs/guide/metrics.md",sidebar_label:"Metrics",sidebar:"docsSidebar",previous:{title:"Business Logic & Hooks",permalink:"/temple-docs/docs/guide/hooks"},next:{title:"Omitting Endpoints",permalink:"/temple-docs/docs/guide/omitting-endpoints"}},l=[{value:"Adding Metrics to Your Project",id:"adding-metrics-to-your-project",children:[]},{value:"Viewing Metrics",id:"viewing-metrics",children:[{value:"Automating Requests",id:"automating-requests",children:[]}]},{value:"Under the Hood of Metrics",id:"under-the-hood-of-metrics",children:[{value:"Prometheus Metrics",id:"prometheus-metrics",children:[]}]}],u={rightToc:l};function p(e){var t=e.components,a=Object(r.a)(e,["components"]);return Object(i.b)("wrapper",Object(n.a)({},u,a,{components:t,mdxType:"MDXLayout"}),Object(i.b)("p",null,"Being able to extract meaningful metrics is a crucial part of any microservice-oriented system.\nThat's why we've made it easy to add metrics to your Temple project, for you to view quantitative data about successes and failures, as well as latency information."),Object(i.b)("p",null,"For this guide, we'll be using the project from the ",Object(i.b)("a",Object(n.a)({parentName:"p"},{href:"../getting-started"}),"Getting Started")," guide as our starting point."),Object(i.b)("h2",{id:"adding-metrics-to-your-project"},"Adding Metrics to Your Project"),Object(i.b)("p",null,"To add metrics to your Temple project, you just need to add a single metadata item to your ",Object(i.b)("inlineCode",{parentName:"p"},"project"),":"),Object(i.b)("pre",null,Object(i.b)("code",Object(n.a)({parentName:"pre"},{className:"language-templefile",metastring:"{5}","{5}":!0}),"ExampleProject: project {\n  #language(go);\n  #database(postgres);\n  #provider(dockerCompose);\n  #metrics(prometheus);\n}\n\nExampleService: service {\n  foo: string;\n  bar: int;\n}\n")),Object(i.b)("p",null,"This indicates that each service in the project will export some metrics to ",Object(i.b)("a",Object(n.a)({parentName:"p"},{href:"https://prometheus.io"}),"Prometheus"),", a popular open source monitoring system.\nPrometheus data is then exposed for visualisation with ",Object(i.b)("a",Object(n.a)({parentName:"p"},{href:"https://grafana.com/grafana/"}),"Grafana"),".\nThis is currently the only supported metrics configuration that Temple supports."),Object(i.b)("p",null,"After regenerating your project, you'll find several new folders have appeared:"),Object(i.b)("pre",null,Object(i.b)("code",Object(n.a)({parentName:"pre"},{className:"language-bash"}),".\n\u251c\u2500\u2500 grafana\n\u2502\xa0\xa0 \u2514\u2500\u2500 provisioning\n\u2502\xa0\xa0     \u251c\u2500\u2500 dashboards\n\u2502\xa0\xa0     \u2502\xa0\xa0 \u251c\u2500\u2500 dashboards.yml\n\u2502\xa0\xa0     \u2502\xa0\xa0 \u2514\u2500\u2500 example-service.json\n\u2502\xa0\xa0     \u2514\u2500\u2500 datasources\n\u2502\xa0\xa0         \u2514\u2500\u2500 datasource.yml\n\u2514\u2500\u2500 prometheus\n    \u2514\u2500\u2500 prometheus.yml\n")),Object(i.b)("p",null,"These two folders provide the configuration for Grafana and Prometheus, and are mounted into their associated Docker container when it is started.\nMore information about these files can be found in the ",Object(i.b)("a",Object(n.a)({parentName:"p"},{href:"https://grafana.com/docs/grafana/latest/reference/dashboard/"}),"Grafana Documentation")," and ",Object(i.b)("a",Object(n.a)({parentName:"p"},{href:"https://prometheus.io/docs/prometheus/latest/configuration/configuration/"}),"Prometheus Documentation"),"."),Object(i.b)("h2",{id:"viewing-metrics"},"Viewing Metrics"),Object(i.b)("p",null,"Viewing metrics from your service is very straight forward, first spin up your infrastructure using the provided deployment script:"),Object(i.b)("pre",null,Object(i.b)("code",Object(n.a)({parentName:"pre"},{className:"language-bash"}),"\u276f\u276f\u276f source deploy.sh\n")),Object(i.b)("p",null,"Then, open ",Object(i.b)("inlineCode",{parentName:"p"},"localhost:3000")," in your browser."),Object(i.b)("div",{className:"admonition admonition-tip alert alert--success"},Object(i.b)("div",Object(n.a)({parentName:"div"},{className:"admonition-heading"}),Object(i.b)("h5",{parentName:"div"},Object(i.b)("span",Object(n.a)({parentName:"h5"},{className:"admonition-icon"}),Object(i.b)("svg",Object(n.a)({parentName:"span"},{xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"}),Object(i.b)("path",Object(n.a)({parentName:"svg"},{fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"})))),"tip")),Object(i.b)("div",Object(n.a)({parentName:"div"},{className:"admonition-content"}),Object(i.b)("p",{parentName:"div"},"If you're using Kubernetes instead of Docker Compose, you'll want to run the following command, which will open the Grafana dashboard in your browser:"),Object(i.b)("pre",{parentName:"div"},Object(i.b)("code",Object(n.a)({parentName:"pre"},{}),"\u276f\u276f\u276f minikube service grafana \n")))),Object(i.b)("p",null,"This should present you with the Grafana login window.\nThe default login is ",Object(i.b)("inlineCode",{parentName:"p"},"admin")," for both the username and password:"),Object(i.b)("img",{alt:"Grafana Login",src:Object(o.a)("img/grafana-login.png")}),Object(i.b)("p",null,"You may be prompted to change the default password, in which case set it to something memorable."),Object(i.b)("p",null,"After logging in, you'll want to head to the left-side bar, and select Dashboards > Manage Dashboards"),Object(i.b)("p",{align:"center"},Object(i.b)("img",{alt:"Grafana Dashboard Menu",src:Object(o.a)("img/grafana-dashboard-menu.png"),width:"25%"})),Object(i.b)("p",null,"This should present you with a list of dashboards: namely one for each service.\nRight now we only have one dashboard for our ",Object(i.b)("inlineCode",{parentName:"p"},"ExampleService"),":"),Object(i.b)("img",{alt:"Grafana Dashboard Manager",src:Object(o.a)("img/grafana-dashboard-manager.png")}),Object(i.b)("p",null,"Let's open it up and see what panels are generated:"),Object(i.b)("img",{alt:"Grafana Empty Dashboard",src:Object(o.a)("img/grafana-empty-panels.png")}),Object(i.b)("p",null,"You'll see there are 8 panels here: two for each endpoint.\nWe use one panel to show successful and failed requests, and the other to show latency of database queries broken down into 50th, 90th, 95th and 99th percentiles.\nHowever, we currently don't have any data to show in this dashboard, because no tests have been made. "),Object(i.b)("h3",{id:"automating-requests"},"Automating Requests"),Object(i.b)("p",null,"You could now start making some manual requests to your service and see the associated metrics pop up on each panel.\nHowever, we've built an automated request tool directly into Temple, allowing you to mock requests from end users."),Object(i.b)("p",null,"To do this, we're going to be using the ",Object(i.b)("inlineCode",{parentName:"p"},"temple test")," command.\nAs explained in the ",Object(i.b)("a",Object(n.a)({parentName:"p"},{href:"temple-test"}),"Temple Test")," guide, ",Object(i.b)("inlineCode",{parentName:"p"},"temple test")," has two main operating modes: "),Object(i.b)("ol",null,Object(i.b)("li",{parentName:"ol"},"Testing including spinning up and then destroying the associated infrastructure"),Object(i.b)("li",{parentName:"ol"},"Testing without touching the infrastructure")),Object(i.b)("p",null,"In this guide we're going to be using the second mode."),Object(i.b)("p",null,"To invoke this, we're going to use the following command:"),Object(i.b)("pre",null,Object(i.b)("code",Object(n.a)({parentName:"pre"},{className:"language-bash"}),"\u276f\u276f\u276f temple test --testOnly example.temple\n\ud83e\uddea Testing ExampleService service\n    \u2705 ExampleService create\n    \u2705 ExampleService read\n    \u2705 ExampleService update\n    \u2705 ExampleService delete\n\ud83c\udf89 Everything passed\n")),Object(i.b)("p",null,"You can run that as many times as you'd like, and after a few seconds you should start to see metrics appearing on the dashboard!"),Object(i.b)("img",{alt:"Grafana Metrics",src:Object(o.a)("img/grafana-metrics.png")}),Object(i.b)("h2",{id:"under-the-hood-of-metrics"},"Under the Hood of Metrics"),Object(i.b)("p",null,"There's a lot going on behind the scenes to make metrics work this seamlessly:"),Object(i.b)("ul",null,Object(i.b)("li",{parentName:"ul"},"Each Go service starts an additional HTTP server that exposes Prometheus metrics"),Object(i.b)("li",{parentName:"ul"},"Prometheus periodically scrapes each HTTP endpoint for the data, and forwards this to Grafana"),Object(i.b)("li",{parentName:"ul"},"Grafana then displays this data using queries defined in ",Object(i.b)("a",Object(n.a)({parentName:"li"},{href:"https://prometheus.io/docs/prometheus/latest/querying/basics/"}),"PromQL"))),Object(i.b)("h3",{id:"prometheus-metrics"},"Prometheus Metrics"),Object(i.b)("p",null,"We expose 3 different types of metrics from each service:"),Object(i.b)("ol",null,Object(i.b)("li",{parentName:"ol"},"A counter of successful requests")),Object(i.b)("ul",null,Object(i.b)("li",{parentName:"ul"},"This is named ",Object(i.b)("inlineCode",{parentName:"li"},"${service}_request_success_total")),Object(i.b)("li",{parentName:"ul"},"The request type is provided as a label named ",Object(i.b)("inlineCode",{parentName:"li"},"request_type"),", so that you can both aggregate and split all successful requests as desired")),Object(i.b)("ol",{start:2},Object(i.b)("li",{parentName:"ol"},"A counter of failed requests")),Object(i.b)("ul",null,Object(i.b)("li",{parentName:"ul"},"This is named ",Object(i.b)("inlineCode",{parentName:"li"},"${service}_request_failure_total")),Object(i.b)("li",{parentName:"ul"},"The request type is provided as a label named ",Object(i.b)("inlineCode",{parentName:"li"},"request_type"),", so that you can both aggregate and split all failed requests as desired")),Object(i.b)("ol",{start:3},Object(i.b)("li",{parentName:"ol"},"A summary of database request durations")),Object(i.b)("ul",null,Object(i.b)("li",{parentName:"ul"},"This is named ",Object(i.b)("inlineCode",{parentName:"li"},"${service}_database_request_seconds")),Object(i.b)("li",{parentName:"ul"},"The query type is provided as a label named ",Object(i.b)("inlineCode",{parentName:"li"},"query_type"),", so that you can both aggregate and split all database requests as desired")),Object(i.b)("p",null,"The exposed Prometheus counters for your ",Object(i.b)("inlineCode",{parentName:"p"},"ExampleService")," can be found in ",Object(i.b)("inlineCode",{parentName:"p"},"example-service/metric/metrics.go"),"."),Object(i.b)("p",null,"The underlying ",Object(i.b)("inlineCode",{parentName:"p"},"PromQL")," queries in Grafana display this data by considering the rate of change over the last 5 minutes.\nFor example, the successful create requests are plotted as:"),Object(i.b)("pre",null,Object(i.b)("code",Object(n.a)({parentName:"pre"},{className:"language-promql"}),'rate(exampleservice_request_success_total{request_type="create"}[5m])\n')))}p.isMDXComponent=!0},176:function(e,t,a){"use strict";a.d(t,"a",(function(){return p})),a.d(t,"b",(function(){return m}));var n=a(0),r=a.n(n);function i(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function o(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function s(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?o(Object(a),!0).forEach((function(t){i(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):o(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function c(e,t){if(null==e)return{};var a,n,r=function(e,t){if(null==e)return{};var a,n,r={},i=Object.keys(e);for(n=0;n<i.length;n++)a=i[n],t.indexOf(a)>=0||(r[a]=e[a]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(n=0;n<i.length;n++)a=i[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(r[a]=e[a])}return r}var l=r.a.createContext({}),u=function(e){var t=r.a.useContext(l),a=t;return e&&(a="function"==typeof e?e(t):s({},t,{},e)),a},p=function(e){var t=u(e.components);return r.a.createElement(l.Provider,{value:t},e.children)},b={inlineCode:"code",wrapper:function(e){var t=e.children;return r.a.createElement(r.a.Fragment,{},t)}},d=Object(n.forwardRef)((function(e,t){var a=e.components,n=e.mdxType,i=e.originalType,o=e.parentName,l=c(e,["components","mdxType","originalType","parentName"]),p=u(a),d=n,m=p["".concat(o,".").concat(d)]||p[d]||b[d]||i;return a?r.a.createElement(m,s({ref:t},l,{components:a})):r.a.createElement(m,s({ref:t},l))}));function m(e,t){var a=arguments,n=t&&t.mdxType;if("string"==typeof e||n){var i=a.length,o=new Array(i);o[0]=d;var s={};for(var c in t)hasOwnProperty.call(t,c)&&(s[c]=t[c]);s.originalType=e,s.mdxType="string"==typeof e?e:n,o[1]=s;for(var l=2;l<i;l++)o[l]=a[l];return r.a.createElement.apply(null,o)}return r.a.createElement.apply(null,a)}d.displayName="MDXCreateElement"},177:function(e,t,a){"use strict";var n=a(0),r=a(53);t.a=function(){return Object(n.useContext)(r.a)}},178:function(e,t,a){"use strict";a.d(t,"a",(function(){return r}));a(182);var n=a(177);function r(e){var t=(Object(n.a)().siteConfig||{}).baseUrl,a=void 0===t?"/":t;if(!e)return e;return/^(https?:|\/\/)/.test(e)?e:e.startsWith("/")?a+e.slice(1):a+e}},180:function(e,t,a){var n=a(52),r=a(27);e.exports=function(e,t,a){if(n(t))throw TypeError("String#"+a+" doesn't accept regex!");return String(r(e))}},181:function(e,t,a){var n=a(2)("match");e.exports=function(e){var t=/./;try{"/./"[e](t)}catch(a){try{return t[n]=!1,!"/./"[e](t)}catch(r){}}return!0}},182:function(e,t,a){"use strict";var n=a(18),r=a(35),i=a(180),o="".startsWith;n(n.P+n.F*a(181)("startsWith"),"String",{startsWith:function(e){var t=i(this,e,"startsWith"),a=r(Math.min(arguments.length>1?arguments[1]:void 0,t.length)),n=String(e);return o?o.call(t,n,a):t.slice(a,a+n.length)===n}})}}]);